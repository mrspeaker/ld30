/*
	Ω500 library
	by Mr Speaker
	https://github.com/mrspeaker/omega500
*/
var Ω=function(){"use strict";var e=true,t=false,n=0,r=0,i=[];return{evt:{onloads:[],progress:[],onload:function(e){if(!t){this.onloads.push(e)}else{e()}}},env:{x:0,y:0,w:0,h:0},preload:function(i){if(!e){return function(){}}r=Math.max(++n,r);return function(){n-=1;Ω.evt.progress.map(function(e){return e(n,r)});if(n===0&&t){if(!e){console.error("Preloading finished (onload called) multiple times!")}e=false;Ω.evt.onloads.map(function(e){e()})}}},pageLoad:function(){t=true;if(r===0||n===0){e=false;Ω.evt.onloads.map(function(e){e()})}},timers:{add:function(e){i.push(e)},tick:function(){i=i.filter(function(e){return e.tick()})}},urlParams:function(){if(!window.location&&!window.location.search){return{}}var e={},t,n=/\+/g,r=/([^&=]+)=?([^&]*)/g,i=function(e){return decodeURIComponent(e.replace(n," "))},s=window.location.search.substring(1);while(t=r.exec(s)){e[i(t[1])]=i(t[2])}return e}()}}();Array.isArray||(Array.isArray=function(e){return""+e!==e&&{}.toString.call(e)=="[object Array]"});window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame;(function(e){var t=false,n=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;e.Class=function(){};e.Class.extend=function(e){function o(){if(!t&&this.init){this.init.apply(this,arguments)}}var r=this.prototype;t=true;var i=new this;t=false;for(var s in e){i[s]=typeof e[s]=="function"&&typeof r[s]=="function"&&n.test(e[s])?function(e,t){return function(){var n=this._super;this._super=r[e];var i=t.apply(this,arguments);this._super=n;return i}}(s,e[s]):e[s]}o.prototype=i;o.prototype.constructor=o;o.extend=arguments.callee;return o}})(Ω);(function(e){"use strict";var t={cast:function(e,t,n,r){e%=Math.PI*2;if(e<0)e+=Math.PI*2;var i=Math.PI*2,s=t/r.sheet.w,o=n/r.sheet.h,u=e>i*.75||e<i*.25,a=e>Math.PI,f=Math.sin(e),l=Math.cos(e),c=null,h=0,p,d,v=0,m=0,g=0,y,b,w=f/l,E=u?1:-1,S=E*w,x=u?Math.ceil(s):Math.floor(s),T=o+(x-s)*w;while(x>=0&&x<r.cellW&&T>=0&&T<r.cellH){y=Math.floor(x+(u?0:-1));b=Math.floor(T);g=r.cells[b][y];if(g>0){p=x-s;d=T-o;c=Math.sqrt(p*p+d*d);v=x;m=T;break}x+=E;T+=S}w=l/f;S=a?-1:1;E=S*w;T=a?Math.floor(o):Math.ceil(o);x=s+(T-o)*w;while(x>=0&&x<r.cellW&&T>=0&&T<r.cellH){b=Math.floor(T+(a?-1:0));y=Math.floor(x);g=b<0?null:r.cells[b][y];if(g){p=x-s;d=T-o;h=Math.sqrt(p*p+d*d);if(c===null||h<c){c=h;v=x;m=T}break}x+=E;T+=S}if(c){return{x:v,y:m}}else{return null}},render:function(e,t,n,r,i,s){var o=e.ctx;o.strokeStyle="rgba(100,0,0,0.2)";o.lineWidth=.5;o.beginPath();o.moveTo(t,n);o.lineTo(r*s.sheet.w,i*s.sheet.h);o.closePath();o.stroke()}};e.rays=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({init:function(t,n,r){e.timers.add(this);this.time=t;if(!r){r=n;n=null}this.max=t;this.cb=n;this.done=r},tick:function(){this.time-=1;if(this.time<0){this.done&&this.done();return false}this.cb&&this.cb(1-this.time/this.max);return true}});e.timer=function(e,n,r){return new t(e,n,r)}})(window.Ω);(function(e){"use strict";e.utils={rand:function(e,t){e=e||1;t=t||0;return Math.floor(Math.random()*(e-t))+t},oneIn:function(e){return this.rand(e)===1},rnd:{seed:42,rand:function(e,t){e=e||1;t=t||0;this.seed=(this.seed*9301+49297)%233280;return this.seed/233280*(e-t)+t|0}},now:function(){return Date.now()},since:function(e){return this.now()-e},toggle:function(e,t,n){return(this.now()+(n||0))/e%t>>0},neighbours:function(e,t,n){var r,i;for(r=-e;r<=e;r++){for(i=-e;i<=e;i++){if(n&&Math.abs(i)!==e&&Math.abs(r)!==e){continue}t&&t(i,r)}}},constrain:function(e,t,n){var r=e[0],i=e[1];if(r<0){r=n?t.w:0}if(i<0){i=n?t.h:0}if(r>t.w){r=n?0:t.w}if(i>t.h){i=n?0:t.h}return[r,i]},formatTime:function(e){e/=1e3;var t=~~(e/60),n=~~(e-t*60);t=t.toString().length===1?""+t:t;n=n.toString().length===1?"0"+n:n;return t+":"+n},formatScore:function(e,t){return(e+Math.pow(10,t)+"").slice(1)},loadScripts:function(e,t){var n=0;e.forEach(function(r){var i=document.createElement("script"),s=window.env.desktop?"?"+(new Date).getTime():"";i.src="scripts/"+r+".js"+s;i.onload=function(){if(n++===e.length-1){t&&t()}};document.body.appendChild(i)})},getByKeyValue:function(e,t,n){return this.getAllByKeyValue(e,t,n)[0]},getAllByKeyValue:function(e,t,n){return e.filter(function(e){if(e[t]&&e[t]===n){return true}})},ajax:function(e,t){var n=new XMLHttpRequest;n.addEventListener("readystatechange",function(){if(this.readyState<4){return}if(n.readyState==4){t(n)}},false);n.open("GET",e,true);n.send("")},fullscreen:{toggle:function(e){if(!document.fullscreenElement&&!document.mozFullScreenElement&&!document.webkitFullscreenElement){this.request(e)}else{this.cancel()}},request:function(e){if(typeof e==="string"){e=document.querySelector(e)}if(e.requestFullscreen){e.requestFullscreen()}else if(e.mozRequestFullScreen){e.mozRequestFullScreen()}else if(e.webkitRequestFullscreen){e.webkitRequestFullscreen()}},cancel:function(){if(document.cancelFullScreen){document.cancelFullScreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}}}}})(window.Ω);(function(e){"use strict";var t={dist:function(e,t){var n=e.x?e.x-t.x:e[0]-t[0],r=e.y?e.y-t.y:e[1]-t[1];return Math.sqrt(n*n+r*r)},distCenter:function(e,t){var n=e.x+e.w/2-(t.x+t.w/2),r=e.y+e.h/2-(t.y+t.h/2);return Math.sqrt(n*n+r*r)},center:function(e,t){t=t||1;return{x:e.x+e.w/t/2,y:e.y+e.h/t/2}},rotate:function(e,t,n){n=n||[0,0];var r=Math.cos(e)*(t[0]-n[0])-Math.sin(e)*(t[1]-n[1])+n[0],i=Math.sin(e)*(t[0]-n[0])+Math.cos(e)*(t[1]-n[1])+n[1];return[r,i]},degToRad:function(e){return e*Math.PI/180},radToDeg:function(e){return e*180/Math.PI},angleBetween:function(e,t){var n=e.x-t.x,r=e.y-t.y,i=Math.atan2(r,n);return i},snap:function(e,t){return Math.floor(e/t)*t},snapRound:function(e,t){var n=e/t|0,r=e-n*t,i=r>t/2?Math.ceil:Math.floor;return i(e/t)*t},clamp:function(e,t,n){return Math.max(t,Math.min(n,e))},ratio:function(e,t,n){return this.clamp((n-e)/(t-e),0,1)},lerp:function(e,t,n){return n*this.ratio(e,t,n)},lerpPerc:function(e,t,n){return(t-e)*n+e},smoothstep:function(e,t,n){var r=this.ratio(e,t,n);return n*r*r*r*(r*(r*6-15)+10)},ease:{linear:function(e,t,n){return(t-e)*n+e},inOutQuad:function(e,t,n){return e+(t-e)/2*(n<.5?2*n*n:-2*n*(n-2)-1)},bounce:function(e,t,n){var r=n*n,i=r*n;return e+(t-e)*(33*i*r+ -106*r*r+126*i+ -67*r+15*n)}}};e.math=t})(window.Ω);(function(e){"use strict";var t=function(e){this.state=e;this.last="";this.count=-1;this.locked=false};t.prototype={set:function(e,t,n){if(this.locked||e===this.state&&!n){return}this.data=t;this.last=this.state;this.state=e;this.count=-1},get:function(){return this.state},tick:function(){this.count++},first:function(){return this.count===0},is:function(e){return e===this.state},isNot:function(e){return!this.is(e)},isIn:function(){var e=this.state,t=Array.prototype.slice.call(arguments);return t.some(function(t){return t===e})},isNotIn:function(){return!this.isIn.apply(this,arguments)}};e.utils=e.utils||{};e.utils.State=t})(window.Ω);(function(e){"use strict";var t=function(){var t=Date.now(),n=t,r=0,i=100,s=0,o=0;return{pos:[e.env.w-53,3],start:function(){t=Date.now()},fps:function(){return[r,i,s]},stop:function(){var e=Date.now();o++;if(e>n+1e3){r=Math.round(o*1e3/(e-n));i=Math.min(i,r);s=Math.max(s,r);n=e;o=0}}}};e.utils=e.utils||{};e.utils.Stats=t})(window.Ω);(function(e){"use strict";var t=-1,n=[],r={c64:["#000000","#FFFFFF","#68372B","#70A4B2","#6F3D86","#588D43","#352879","#B8C76F","#6F4F25","#433900","#9A6759","#444444","#6C6C6C","#9AD284","#6C5EB5","#959595"]},i;i={set:function(e){if(Array.isArray(e)){n=e.slice(0);return}if(r[e]){n=r[e].slice(0);return}n.length=0;for(var t=0;t<36;t++){n.push("hsl("+(t*10|0)+", 50%, 50%)")}},get:function(t){return n[e.math.clamp(t%n.length,0,n.length-1)]},rnd:function(){return n[Math.random()*n.length|0]},rndHSL:function(e,t){e=e===undefined?50:e;t=t===undefined?50:t;return"hsl("+(Math.random()*360|0)+", "+e+"%, "+t+"%)"},next:function(){t=(t+1)%n.length;return n[t]}};i.set();e.utils=e.utils||{};e.utils.colors=i})(window.Ω);(function(e){"use strict";var t={};var n={init:function(e){this.ctx=e;this.canvas=e.canvas;this.w=this.canvas.width;this.h=this.canvas.height},loadImage:function(n,r,i){var s=t[n+(i?":"+i:"")];if(s){if(!s._loaded){s.addEventListener("load",function(){r&&r(s)},false);s.addEventListener("load",function(){r&&r(s)},false)}else{r&&r(s)}return}var o=e.preload(n),u=new Image,a=this,f=function(){var e;if(i>=0){e=a.flipImage(u,i)}this._loaded=true;r&&r(e||u);o()};u._loaded=false;u.src=n;u.addEventListener("load",f,false);u.addEventListener("error",function(){console.error("Error loading image",n);f.call(this)},false);t[n+(i?":"+i:"")]=u},drawImage:function(e,t,n,r,i){this.ctx.drawImage(e,t,n,e.width*r?r:1,e.height*i?i:1)},flipImage:function(e,t){var n=this.createCanvas(e.width,e.height);n.save();n.translate(t&1?e.width:0,t&2?e.height:0);n.scale(t&1?-1:1,t&2?-1:1);n.drawImage(e,0,0);n.restore();return n.canvas},clear:function(e,t){var n=this.ctx,r;t=t===undefined?1:t;if(t!==1){r=n.globalAlpha;n.globalAlpha=t}n.fillStyle=e;n.fillRect(0,0,this.w,this.h);if(r){n.globalAlpha=r}},createCanvas:function(e,t){var n=document.createElement("canvas"),r=n.getContext("2d");n.setAttribute("width",e);n.setAttribute("height",t);r.imageSmoothingEnabled=false;r.mozImageSmoothingEnabled=false;r.webkitImageSmoothingEnabled=false;return r},text:{drawShadowed:function(e,t,r,i,s){var o=n.ctx;i=i||2;if(s){o.font=s}o.fillStyle="#000";o.fillText(e,t+i,r+i);o.fillStyle="#fff";o.fillText(e,t,r)},getWidth:function(e){return n.ctx.measureText(e).width},getHalfWidth:function(e){return this.getWidth(e)/2},getHeight:function(e){return n.ctx.measureText(e).height},getHalfHeight:function(e){return this.getHeight(e)/2}}};e.gfx=n})(window.Ω);(function(e){"use strict";function u(e,n){if(t[e]){t[e].wasDown=t[e].isDown;t[e].isDown=n}if(n){s.lastKey=e;s.lastKeyTime=Date.now()}}function a(e,t){var n=[87,69,88,90,68,67,65,81,89,84],r=s.KEYS;if(n.indexOf(e)>-1){if(!t){return}switch(e){case 87:e=r.up;t=true;break;case 69:e=r.up;t=false;break;case 88:e=r.down;t=true;break;case 90:e=r.down;t=false;break;case 68:e=r.right;t=true;break;case 67:e=r.right;t=false;break;case 65:e=r.left;t=true;break;case 81:e=r.left;t=false;break;case 89:e=r.space;t=true;break;case 84:e=r.space;t=false;break}}u(e,t)}function f(e){document.addEventListener("keydown",function(t){e(t.keyCode,true)},false);document.addEventListener("keyup",function(t){e(t.keyCode,false)},false)}function l(){function e(e){var t=e.clientX-o.offsetLeft,r=e.clientY-o.offsetTop;n.diff={x:n.x-t,y:n.y-r};n.prev={x:n.x,y:n.y};n.x=t;n.y=r}function t(e){var t=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));if(t===-1)u(s.KEYS.wheelUp,true);if(t===1)u(s.KEYS.wheelDown,true)}document.addEventListener("mousedown",function(t){if(t.which===1){e(t);u(-1,true)}});document.addEventListener("mousemove",function(t){e(t)});document.addEventListener("mouseup",function(t){if(t.which===1){e(t);u(-1,false)}});document.addEventListener("mousewheel",t,false);document.addEventListener("DOMMouseScroll",t,false)}function c(){function e(e){var t;if(e.type==="touchend"){t=e.changedTouches?e.changedTouches[0]:e}else{t=e.touches?e.touches[0]:e}var n=t.clientX-o.offsetLeft,i=t.clientY-o.offsetTop;r.diff={x:r.x-n,y:r.y-i};r.prev={x:r.x,y:r.y};r.x=n;r.y=i}document.addEventListener("touchstart",function(t){e(t);u(s.KEYS.touch,true)},false);document.addEventListener("touchmove",function(t){t.preventDefault();e(t);u(s.KEYS.touchMove,true)},false);document.addEventListener("touchend",function(t){e(t);u(s.KEYS.touch,false);u(s.KEYS.touchMove,false)},false)}var t={},n={x:null,y:null},r={x:null,y:null},i={},s,o;s={KEYS:{enter:13,space:32,escape:27,up:38,down:40,left:37,right:39,w:87,a:65,s:83,d:68,az_w:90,az_a:81,az_s:83,az_d:68,mouse1:-1,mouse2:-2,mouse3:-3,wheelUp:-4,wheelDown:-5,touch:-6,touchMove:-7},mouse:n,touch:r,lastKey:null,lastKeyTime:Date.now(),init:function(t,n){o=t;n=n||e.urlParams.icade;f(!n?u:a);l();c()},reset:function(){var e;for(e in t){t[e].isDown=false;t[e].wasDown=false}},tick:function(){var e;for(e in t){t[e].wasDown=t[e].isDown}if(t[s.KEYS.wheelUp])u(s.KEYS.wheelUp,false);if(t[s.KEYS.wheelDown])u(s.KEYS.wheelDown,false)},bind:function(e,n){var r;if(typeof e==="object"){r=e;for(e in r){var s=r[e];if(Array.isArray(s)){s.forEach(function(t){this.bind(e,t)},this)}else{this.bind(e,s)}}return}if(typeof n!=="number"){n=this.KEYS[n];if(!n){console.error("Could not bind input: ",n);return}}t[n]={action:e,isDown:false,wasDown:false};if(!i[e]){i[e]=[]}i[e].push(n)},pressed:function(e){return this.isDown(e)&&!this.wasDown(e)},released:function(e){return this.wasDown(e)&&!this.isDown(e)},isDown:function(e){var n=i[e]||[];return n.some(function(e){return t[e].isDown})},wasDown:function(e){var n=i[e]||[];return n.some(function(e){return t[e].wasDown})},release:function(e){var t=i[e]||[];t.forEach(function(e){u(e,false)})}};e.input=s})(window.Ω);(function(e){"use strict";var t=e.Class.extend({w:0,h:0,init:function(t,n,r){var i=this;this.path=t;e.gfx.loadImage(t,function(e){i.img=e;i.w=e.width*i.scale;i.h=e.height*i.scale},n);this.scale=r||1},render:function(e,t,n){e.ctx.drawImage(this.img,t,n,this.img.width*this.scale,this.img.height*this.scale)}});e.Image=t})(window.Ω);(function(e){"use strict";var t={},n;n=e.Class.extend({ext:document.createElement("audio").canPlayType("audio/mpeg;")===""?".ogg":".mp3",init:function(n,r,i){var s,o,u;if(!t[n]){s=new window.Audio;o=e.preload(n);u=function(){if(this._loaded){return}this._loaded=true;o()};s.src=n.slice(-4).slice(0,1)==="."?n:n+this.ext;s._loaded=false;s.addEventListener("canplaythrough",u,false);var a=function(){u.call(this);s.removeEventListener("progress",a)};s.addEventListener("progress",a,false);s.addEventListener("error",function(){console.error("Error loading audio resource:",s.src);u.call(this)});s.load();t[n]=s}s=t[n];s.volume=r||1;s._volume=s.volume;s.loop=i;this.audio=s},rewind:function(){this.audio.pause();try{this.audio.currentTime=0}catch(e){}},play:function(e){if(!this.audio.paused&&!e){return}this.rewind();this.audio.play()},stop:function(){this.audio.pause()}});n._reset=function(){var e,n;for(e in t){n=t[e];if(!n._loaded)continue;n.pause();try{n.currentTime=0}catch(r){console.log("err")}}};n._setVolume=function(e){for(var n in t){t[n].pause();try{t[n].volume=t[n]._volume*e}catch(r){console.log("err")}}};e.Sound=n})(window.Ω);(function(e){"use strict";var t=e.Class.extend({w:null,h:null,tileW:null,tileH:null,layers:null,init:function(t,n){var r=this;this.layers=[];this.onload=n;e.utils.ajax(t,function(e){r.processLevel(JSON.parse(e.responseText))})},layer:function(t){var n=e.utils.getByKeyValue(this.layers,"name",t),r=this.tileH,i=function(e){if(e.width===0&&e.height===0){e.y-=r}return e};if(!n){return null}return{get:function(){return n},name:function(e,t){var r=n.data.filter(function(t){return t.name===e}).map(i);return r.length?r[0]:t},prop:function(e,t){return n.data[0][e];var r=n.data.filter(function(t){return t[e]===selector}).map(i);return r.length?r[0]:t},type:function(e,t){var r=n.data.filter(function(t){return t.type===e}).map(i);return r.length===0&&t?t:r}}},processLevel:function(e){this.raw=e;this.w=e.width;this.h=e.height;this.tileW=e.tilewidth;this.tileH=e.tileheight;this.properties=e.properties;this.layers=e.layers.map(function(t){var n;if(t.type==="tilelayer"){n=t.data.reduce(function(t,n){if(t.length===0||t[t.length-1].length%e.width===0){t.push([])}t[t.length-1].push(n);return t},[])}else{n=t.objects.map(function(e){return e})}return{name:t.name,type:t.type,data:n,opacity:t.opacity,visible:t.visible}});if(this.onload){this.onload(this)}}});e.Tiled=t})(Ω);(function(e){"use strict";var t=e.Class.extend({x:0,y:0,w:0,h:0,debug:false,init:function(e,t,n,r){this.x=e;this.y=t;this.w=n;this.h=r;this.zoom=1},tick:function(){},moveTo:function(e,t){this.x=e;this.y=t},moveBy:function(e,t){this.x+=e;this.y+=t},renderPre:function(e){var t=e.ctx;t.save();t.scale(this.zoom,this.zoom);t.translate(-Math.round(this.x),-Math.round(this.y))},renderPost:function(e){var t=e.ctx;if(this.debug){t.strokeStyle="red";t.strokeRect(this.x,this.y,this.w/this.zoom,this.h/this.zoom)}t.restore()},render:function(e,t,n){var r=this;!n&&this.renderPre(e);t.reduce(function(e,t){if(Array.isArray(t)){return e.concat(t)}e.push(t);return e},[]).filter(function(e){return e.repeat||!(e.x+e.w<r.x||e.y+e.h<r.y||e.x>r.x+r.w/r.zoom||e.y>r.y+r.h/r.zoom)}).forEach(function(t){t.render(e,r)});!n&&this.renderPost(e)}});e.Camera=t})(window.Ω);(function(e){"use strict";var t=e.Camera.extend({x:0,y:0,w:0,h:0,xRange:40,yRange:30,init:function(e,t,n,r,i,s){this.w=r;this.h=i;this.zoom=1;this.bounds=s;this.track(e)},track:function(e){this.entity=e;this.x=e.x-this.w/this.zoom/2+e.w/this.zoom/2;this.y=e.y-this.h/this.zoom/2;this.constrainToBounds()},constrainToBounds:function(){if(this.x<0){this.x=0}if(this.x>0){if(this.bounds&&this.x+this.w/this.zoom>this.bounds[0]){this.x=this.bounds[0]-this.w/this.zoom}}if(this.y<0){this.y=0}if(this.y>0){if(this.bounds&&this.y+this.h/this.zoom>this.bounds[1]){this.y=this.bounds[1]-this.h/this.zoom}}},tick:function(){var t=e.math.center(this,this.zoom),n=this.entity,r=this.xRange,i=this.yRange;if(n.x<t.x-r){this.x=n.x-this.w/this.zoom/2+r}if(n.x+n.w>t.x+r){this.x=n.x+n.w-this.w/this.zoom/2-r}if(n.y<t.y-i){this.y=n.y-this.h/this.zoom/2+i}if(n.y+n.h>t.y+i){this.y=n.y+n.h-this.h/this.zoom/2-i}this.constrainToBounds()},render:function(t,n){if(!this.debug){this._super(t,n);return}this._super(t,n.concat([{render:function(t,n){var r=e.math.center(n,n.zoom);t.ctx.strokeStyle="rgba(200, 255, 255, 1)";t.ctx.strokeRect(r.x-n.xRange,r.y-n.yRange,n.xRange*2,n.yRange*2)}}]))}});e.TrackingCamera=t})(window.Ω);(function(e){"use strict";var t={checkCollision:function(e,t,n){var r,i=e,s,o,u,a=t.length;n=n||"hit";for(r=0;r<a;r++){s=t[r];o=i.x+(i.xbb||0);u=s.x+(s.xbb||0);if(i!==s&&o+i.w>=u&&o<=u+s.w&&i.y+i.h>=s.y&&i.y<=s.y+s.h){i[n]&&i[n](s);s[n]&&s[n](i)}}},checkCollisions:function(e,t){var n,r,i,s,o=e.reduce(function(e,t){if(Array.isArray(t)){return e.concat(t)}e.push(t);return e},[]),u=o.length;t=t||"hit";for(n=0;n<u-1;n++){i=o[n];for(r=n+1;r<u;r++){s=o[r];if(i!==s&&i.x+i.w>=s.x&&i.x<=s.x+s.w&&i.y+i.h>=s.y&&i.y<=s.y+s.h){i[t]&&i[t](s);s[t]&&s[t](i)}}}},checkPointsCollision:function(e,t,n){var r,i,s,o=e.points||[],u=o.length,a,f,l,c,h=t.length,p=false;n=n||"hit";for(r=0;r<h;r++){l=t[r];c=l.x+(l.xbb||0);for(i=0;i<u;i++){s=o[i];a=s[0];f=s[1];if(a>=c&&a<=c+l.w&&f>=l.y&&f<=l.y+l.h){e[n]&&e[n](l);l[n]&&l[n](e);p=true;break}}}return p}};e.Physics=t})(window.Ω);(function(e){"use strict";function n(e,t){this.parent=t;this.x=0;this.y=0;this.w=4;this.h=4;this.col=e.col;this.xSpeed=Math.random()*2-1;this.ySpeed=Math.random()*2-1-1}var t=e.Class.extend({particles:null,running:false,init:function(e,t){this.maxLife=e.life||40;this.life=this.maxLife;this.cb=t;this.col=e.col||"100, 0, 0";this.particles=[];for(var r=0;r<20;r++){this.particles.push(new n({col:this.col},this))}},play:function(e,t){this.life=this.maxLife;this.x=e;this.y=t;this.running=true;this.particles.forEach(function(e){e.reset()})},tick:function(){if(!this.running){return}this.life-=1;this.particles.forEach(function(e){e.tick()});if(this.life<0){this.running=false;this.cb&&this.cb()}},render:function(e){var t=this;if(!this.running){return}this.particles.forEach(function(n){n.render(e,t.x,t.y)})}});n.prototype={reset:function(){this.life=this.parent.maxLife;this.x=0;this.y=0;this.xSpeed=Math.random()*2-1;this.ySpeed=Math.random()*2-1-3},tick:function(){this.x+=this.xSpeed;this.y+=this.ySpeed;this.ySpeed+=.2},render:function(e,t,n){var r=e.ctx;r.fillStyle="rgba("+this.col+", "+(.3+this.parent.life/this.parent.maxLife)+")";r.fillRect(this.x+t,this.y+n,this.w,this.h)}};e.Particle=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({init:function(e){this.time=e||10},tick:function(){return this.time--},render:function(e){e.ctx.translate(Math.random()*8|0,Math.random()*4|0)}});e.Shake=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({init:function(e,t){this.max=e||10;this.time=this.max;this.color=t||"#fff"},tick:function(){this.ratio=1-this.time/this.max;return this.time--},render:function(e){if(this.ratio>.5){e.clear(this.color,1-(this.ratio-.5)*2)}else{e.clear(this.color,this.ratio*2)}}});e.Flash=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({vel:[0,0],init:function(e,t,n,r){this.springLength=e;this.spring=t;this.friction=n;this.gravity=r},tick:function(e,t){var n=t.x-e.x,r=t.y-e.y,i=Math.atan2(r,n),s=e.x+Math.cos(i)*this.springLength,o=e.y+Math.sin(i)*this.springLength;this.vel[0]+=(s-t.x)*this.spring;this.vel[1]+=(o-t.y)*this.spring;this.vel[0]*=this.friction;this.vel[1]*=this.friction;this.vel[1]+=this.gravity;return this.vel},reset:function(){this.vel=[0,0]}});window.Spring=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({loaded:true,frame:0,bodies:null,_bodies:null,_bodies_zindex:null,camera:null,tick:function(){},_tick:function(){var e=this;this.frame++;if(this._bodies){this.bodies=this.bodies.filter(function(e){var t=e[0],n=e[1]||"default",r=e[2]||99,i=false,s;if(!this._bodies[n]){this._bodies[n]=[];for(s=0;s<this._bodies_zindex.length;s++){if(r<this._bodies_zindex[s][0]){this._bodies_zindex.splice(s,0,[r,n]);i=true;break}}if(!i){this._bodies_zindex.push([r,n])}}this._bodies[n].push(t);return false},this);for(var t in this._bodies){this._bodies[t]=this._bodies[t].filter(function(t){var n=t.tick()&&!t.remove;if(t.bodies){t.bodies=t.bodies.filter(function(t){e.add(t[0],t[1],t[2]);return false})}return n})}}this.tick()},add:function(e,t,n){if(!this._bodies){this.bodies=[];this._bodies_zindex=[[99,"default"]];this._bodies={"default":[]}}this.bodies.push([e,t,n]);return e},get:function(e){return this._bodies[e]||[]},clear:function(e,t){if(this.camera){var n=e.ctx;n.fillStyle=t;n.fillRect(this.camera.x,this.camera.y,this.camera.w,this.camera.h)}else{e.clear(t)}},render:function(e){var t=e.ctx;t.fillStyle="hsl(0, 0%, 0%)";t.fillRect(0,0,e.w,e.h)},_render:function(e){this.renderBG&&this.renderBG(e);if(this.camera){this.camera.renderPre(e);this.render(e,this.camera);if(this._bodies){var t=[];this._bodies_zindex.forEach(function(e){t.push(this._bodies[e[1]])},this);this.camera.render(e,t,true)}this.camera.renderPost(e)}else{this.render(e);if(this._bodies){this._bodies_zindex.forEach(function(t){this._bodies[t[1]].forEach(function(t){t.render(e)},this)},this)}}this.renderFG&&this.renderFG(e)}});e.Screen=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({killKey:"escape",time:0,init:function(e,t){if(typeof e==="function"){t=e;e=null}if(e){this.killKey=e}this.cb=t},tick:function(t){this.time+=t;if(this.killKey&&e.input.pressed(this.killKey)){e.input.release(this.killKey);this.done()}},done:function(){window.game.clearDialog();this.cb&&this.cb()},render:function(e){var t=e.ctx;t.fillStyle="rgba(0, 0, 0, 0.7)";t.fillRect(e.w*.15,e.h*.25,e.w*.7,e.h*.5)}});e.Dialog=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({makeArgs:function(){return[]},init:function(){},init_trait:function(){},tick:function(){return true}});e.Trait=t})(window.Ω);(function(e){"use strict";var t=e.Trait.extend({makeArgs:function(e){return[e.friction]},init_trait:function(e,t){e.velX=0;e.velY=0;e.accX=0;e.accY=0;e.friction=t||.75;this.moveBy=function(t,n){e.accX+=t;e.accY+=n}},tick:function(e){e.velX+=e.accX;e.velY+=e.accY;e.velX*=e.friction;e.velY*=e.friction;e.accX=0;e.accY=0;this.xo+=e.velX;this.yo+=e.velY;return true}});var n=e.Trait.extend({makeArgs:function(e){return[]},init_trait:function(e){e.velY=0;e.accY=0},tick:function(t){if(this.falling){t.accY+=.25;t.accY=e.math.clamp(t.accY,0,20)}else{t.accY=0}this.yo+=t.accY;return true}});var r=e.Trait.extend({makeArgs:function(e){return[e.ticks]},init_trait:function(e,t){e.ticks=t||100},tick:function(e){if(!this.remove&&e.ticks--===0){this.remove=true;console.log("Trait 'remove' executed.")}return!this.remove}});var i=e.Trait.extend({makeArgs:function(e){return[e.ticks,e.cb]},init_trait:function(e,t,n){e.ticks=t||100;e.cb=n||function(){}},tick:function(e){if(e.ticks--<=0){e.cb.call(this,e);console.log("Ticker trait expired");return false}return true}});var s=e.Trait.extend({makeArgs:function(e){return[e.speed,e.amp,e.target]},init_trait:function(e,t,n,r){e.speed=t||100;e.amp=n||5;e.target=r||"yo";return e},tick:function(t){this[t.target]+=Math.sin(e.utils.now()/t.speed)*(t.amp/10);return true}});e.traits={RemoveAfter:r,Ticker:i,Sin:s,Velocity:t,Gravity:n}})(window.Ω);(function(e){"use strict";var t=e.Class.extend({init:function(t,n,r,i){var s={flipFlags:null,margin:[0,0],padding:[0,0]},o=this;this.w=n;this.h=r||n;this.cellW=0;this.cellH=0;if(!isNaN(i)){i={flipFlags:i}}i=i||{};this.flipFlags=i.flipFlags||s.flipFlags;this.margin=i.margin||s.margin;this.padding=i.padding||s.padding;if(typeof t!=="string"){this.populate(t,this.flipFlags)}else{e.gfx.loadImage(t,function(e){o.populate(e,o.flipFlags)})}},populate:function(e,t){this.sheet=e;if(t>=0){this.sheet=this.flipImage(e.canvas||e,t)}this.cellW=Math.ceil((e.width-this.margin[0])/(this.w+this.padding[0]));this.cellH=Math.ceil((e.height-this.margin[1])/(this.h+this.padding[1]))},flipImage:function(t,n){var r=e.gfx.createCanvas(t.width*(n&1?2:1),t.height*(n&2?2:1)),i=t.width/this.w|0,s=t.height/this.h|0,o,u;r.drawImage(t,0,0);if(n&1){for(u=0;u<s;u++){for(o=0;o<i;o++){r.save();r.translate(o*this.w*.5,u*this.h);r.scale(-1,1);this.render({ctx:r},o,u,-(o*this.w*.5)-t.width-this.w,0);r.restore()}}}if(n&2){for(u=0;u<s;u++){for(o=0;o<i;o++){r.save();r.translate(o*this.w,u*this.h*.5);r.scale(1,-1);this.render({ctx:r},o,u,0,-(u*this.h*.5)-t.height-this.h);r.restore()}}}if(n&3){for(u=0;u<s;u++){for(o=0;o<i;o++){r.save();r.translate(o*this.w*.5,u*this.h*.5);r.scale(-1,-1);this.render({ctx:r},o,u,-(o*this.w*.5)-t.width-this.w,-(u*this.h*.5)-t.height-this.h);r.restore()}}}return r.canvas},render:function(e,t,n,r,i,s,o,u){if(t===-1){return}u=u||1;o=o||1;s=s||1;e.ctx.drawImage(this.sheet,t*(this.w+this.padding[0])+this.margin[0],n*(this.h+this.padding[1])+this.margin[1],s*this.w,o*this.h,r,i,s*this.w*u,o*this.h*u)}});e.SpriteSheet=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({map:" !\"#$%&'()*+,-./0123456789:;<=>?@abcdefghijklmnopqrstuvwxyz[/]^_`abcdefghijklmnopqrstuvwxyz{|}~",init:function(t,n,r,i){this.sheet=new e.SpriteSheet(t,n,r);this.map=(i||this.map).split("").map(function(e){return e.charCodeAt(0)});this.w=n;this.h=r},render:function(e,t,n,r){if(!t){return}t=t.toString();var i=this.sheet.cellW;for(var s=0;s<t.length;s++){var o=t.charCodeAt(s),u=this.map.indexOf(o);if(o===32||u===-1){continue}this.sheet.render(e,u%i|0,u/i|0,n+s*this.w,r)}}});e.Font=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({current:null,all:null,init:function(e){if(e.length){this.all=e;this.current=e[0]}},tick:function(){this.current.tick()},add:function(e){if(!this.all){this.all=[];this.current=e}this.all.push(e)},each:function(e){this.all.forEach(e)},get:function(){return this.current.name},set:function(e){var t=this.all.filter(function(t){return t.name===e});if(t.length){this.current=t[0];this.current.reset()}},setTo:function(e){if(this.get()!==e){this.set(e)}},changed:function(){return this.current.changed},rewound:function(){return this.current.rewound},render:function(e,t,n){this.current.render(e,t,n)}});e.Anims=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({init:function(e,t,n,r,i){this.name=e;this.sheet=t;this.frames=r;this.speed=n;this.cb=i;this.scale=1;this.changed=false;this.rewound=false;this.reset()},tick:function(){var t=e.utils.now()-this.frameTime;this.changed=false;this.rewound=false;if(t>this.speed){this.frameTime=e.utils.now()+Math.min(this.speed,t-this.speed);if(++this.curFrame>this.frames.length-1){this.curFrame=0;this.rewound=true;this.cb&&this.cb()}this.changed=true}},reset:function(){this.curFrame=0;this.frameTime=e.utils.now()},render:function(e,t,n){this.sheet.render(e,this.frames[this.curFrame][0],this.frames[this.curFrame][1],t,n,1,1,this.scale)}});e.Anim=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({x:0,y:0,walkable:0,repeat:false,parallax:0,init:function(e,t,n){this.sheet=e;this.walkable=n||0;this.populate(t||[[]])},tick:function(){return true},populate:function(e){this.cells=e;this.cellH=this.cells.length;this.cellW=this.cells[0].length;this.h=this.cellH*this.sheet.h;this.w=this.cellW*this.sheet.w},render:function(e,t){if(!t){t={x:0,y:0,w:e.w,h:e.h,zoom:1}}var n=this.sheet.w,r=this.sheet.h,i=this.sheet.cellW,s=this.sheet.cellH,o=(t.x-t.x*this.parallax)/n|0,u=(t.y-t.y*this.parallax)/r|0,a=o+(t.w/t.zoom/n|0)+1,f=u+(t.h/t.zoom/r|0)+1,l,c,h;if(this.parallax){e.ctx.save();e.ctx.translate(t.x*this.parallax|0,t.y*this.parallax|0)}for(l=u;l<=f;l++){if(l<0||!this.repeat&&l>this.cellH-1){continue}for(c=o;c<=a;c++){if(c<0||!this.repeat&&c>this.cellW-1){continue}h=this.cells[l%this.cellH][c%this.cellW];if(h===0){continue}this.sheet.render(e,(h-1)%i|0,(h-1)/i|0,c*n,l*r)}}if(this.parallax){e.ctx.restore()}},getBlockCell:function(e){var t=e[1]/this.sheet.h|0,n=e[0]/this.sheet.w|0;if(t<0||t>this.cellH-1){t=-1}if(n<0||n>this.cellW-1){n=-1}return[n,t]},getCellPixels:function(e){var t=e[1]*this.sheet.h,n=e[0]*this.sheet.w;return[n,t]},getBlock:function(e){var t=e[1]/this.sheet.h|0,n=e[0]/this.sheet.w|0;if(t<0||t>this.cellH-1){return}return this.cells[t][n]},getBlocks:function(e){return e.map(this.getBlock,this)},getBlockEdge:function(t,n){var r=n?this.sheet.h:this.sheet.w;return e.math.snap(t,r)},setBlock:function(e,t){var n=e[1]/this.sheet.h|0,r=e[0]/this.sheet.w|0;if(n<0||n>this.cellH-1||r<0||r>this.cellW-1){return}this.cells[n][r]=t},setBlockCell:function(e,t){var n=e[1],r=e[0];if(n<0||n>this.cellH-1||r<0||r>this.cellW-1){return}this.cells[n][r]=t},imgToCells:function(t,n,r,i){function f(e){var t=e.getContext("2d"),r=t.webkitGetImageDataHD?t.webkitGetImageDataHD(0,0,e.width,e.height).data:t.getImageData(0,0,e.width,e.height).data,i,f=[],l,c,h,p,d=function(e){return Math.floor(e/10)*10};for(c=0;c<e.height;c++){f.push([]);for(l=0;l<e.width;l++){i=c*e.width*4+l*4;if(r[i+3]!==0){p=d(r[i])+","+d(r[i+1])+","+d(r[i+2])+","+d(r[i+3]);if(n){h=n[p];if(!h){if(o[p]){o[p].push([l,c])}else{o[p]=[[l,c]]}h=0}f[f.length-1].push(h)}else{h=u[p];if(!h){u[p]=++a}f[f.length-1].push(h)}}else{f[f.length-1].push(0)}}}s.populate(f);return o}var s=this,o={},u={},a=0;var l;if(typeof t==="string"){e.gfx.loadImage(t,function(e){document.body.appendChild(e);l=f(e);r&&r(s,l)},i||0)}else{l=f(t)}return l}});e.Map=t})(window.Ω);(function(e){"use strict";var t=e.Class.extend({x:0,y:0,w:32,h:32,xo:0,yo:0,gravity:0,falling:false,wasFalling:false,remove:false,traits:null,bodies:null,init:function(e,t,n,r){this.x=e||this.x;this.y=t||this.y;this.w=n||this.w;this.h=r||this.h;var i=this.traits||[];this.traits=[];this.mixin(i)},tick:function(){this.traits=this.traits.filter(function(e){return e.tick.call(this,e)},this);return!this.remove},add:function(e,t,n){if(!this.bodies){this.bodies=[]}this.bodies.push([e,t,n]);return e},mixin:function(e){e.forEach(function(e){if(e.trait){var t=new e.trait;t.init_trait.apply(this,[t].concat(t.makeArgs(e)));this.traits.push(t)}},this)},hit:function(e){},hitBlocks:function(e,t){},moveBy:function(e,t){this.xo=e;this.yo=t},move:function(e,t,n){var r,i,s,o,u=false,a=false,f,l;if(this.falling){t+=this.gravity}r=e;i=t;s=this.x+r;o=this.y+i;l=n.getBlocks([[this.x,o],[this.x,o+(this.h-1)],[this.x+(this.w-1),o],[this.x+(this.w-1),o+(this.h-1)]]);if(t<0&&(l[0]>n.walkable||l[2]>n.walkable)){i=n.getBlockEdge((o|0)+n.sheet.h,"VERT")-this.y;a=true}if(t>0&&(l[1]>n.walkable||l[3]>n.walkable)){i=n.getBlockEdge(o+this.h,"VERT")-this.y-this.h;a=true}this.y+=i;f=n.getBlocks([[s,this.y],[s,this.y+(this.h-1)],[s+(this.w-1),this.y],[s+(this.w-1),this.y+(this.h-1)]]);if(e<0&&(f[0]>n.walkable||f[1]>n.walkable)){r=n.getBlockEdge(s+n.sheet.w)-this.x;u=true}if(e>0&&(f[2]>n.walkable||f[3]>n.walkable)){r=n.getBlockEdge(s+this.w)-this.x-this.w;u=true}if(u||a){this.hitBlocks(u?f:null,a?l:null)}this.x+=r;l=n.getBlocks([[this.x,this.y+this.h],[this.x+(this.w-1),this.y+this.h]]);this.wasFalling=this.falling;if(l[0]<=n.walkable&&l[1]<=n.walkable){this.falling=true}else{this.falling=false}this.xo=0;this.yo=0;return[r,i]},render:function(e){var t=e.ctx;t.fillStyle="#c00";t.fillRect(this.x,this.y,this.w,this.h)}});e.Entity=t})(window.Ω);(function(e){"use strict";function n(e,t,n){t=t||400;n=n||225;var r=document.querySelector(e),i,s;if(r===null){console.error("Canvas DOM container not found:",e);r=document.querySelector("body")}if(r.nodeName.toUpperCase()==="CANVAS"){var o=r.getAttribute("width"),u=r.getAttribute("height");if(o===null){r.setAttribute("width",t)}if(u===null){r.setAttribute("height",n)}s=r.getContext("2d")}else{i=document.createElement("canvas");i.setAttribute("width",t);i.setAttribute("height",n);r.appendChild(i);s=i.getContext("2d")}s.imageSmoothingEnabled=false;s.mozImageSmoothingEnabled=false;s.webkitImageSmoothingEnabled=false;if(!s){console.error("Could not get 2D context.")}return s}var t=e.Class.extend({canvas:"body",running:false,time:0,preset_dt:1/60,currentTime:Date.now(),accumulator:0,screen:new e.Screen,_screenPrev:null,_fade:function(){return{ratio:0}}(),dialog:null,fps:true,init:function(t,r){var i=n(this.canvas,t,r),s=this;e.env.w=i.canvas.width;e.env.h=i.canvas.height;e.gfx.init(i);e.input.init(i.canvas);e.evt.onload(function(){s.load();s.run(Date.now())});window.addEventListener("load",function(){e.pageLoad()},false);this.running=true;e.utils.now=function(){return s.now()};this.stats=e.utils.Stats()},reset:function(){this.time=0},now:function(){return this.time*1e3},load:function(){},run:function(){var t=this,n=Date.now(),r=Math.min((n-this.currentTime)/1e3,this.preset_dt),i;this.currentTime=n;this.accumulator+=r;if(this.running){i=0;while(this.accumulator>=this.preset_dt){i++;this.tick(this.preset_dt);this.accumulator-=this.preset_dt}if(i>1){console.log("ran "+i+" ticks")}this.render(e.gfx)}window.requestAnimationFrame(function(){t.run(Date.now())})},stop:function(){},tick:function(t){this.stats.start();if(this.dialog){this.dialog.tick(t)}else{this.time+=t;if(this.screen.loaded){this.screen._tick()}e.timers.tick()}e.input.tick();this.stats.stop()},render:function(e){var t=e.ctx;if(!this.screen.loaded){return}if(this._fade.ratio<=0){this.screen._render(e)}else{switch(this._fade.type){case"inout":if(this._fade.ratio>.5){this.screenPrev._render(e);e.clear(this._fade.color,1-(this._fade.ratio-.5)*2)}else{this.screen._render(e);e.clear(this._fade.color,this._fade.ratio*2)}break;case"out":this.screenPrev._render(e);e.clear(this._fade.color,1-this._fade.ratio);break;default:this.screen._render(e);t.globalAlpha=this._fade.ratio;this.screenPrev._render(e);t.globalAlpha=1;break}}this.dialog&&this.dialog.render(e);if(this.fps){var n=this.stats.fps();e.ctx.fillStyle="rgba(0,0,0,0.3)";e.ctx.fillRect(this.stats.pos[0],this.stats.pos[1],50,20);e.ctx.fillStyle="#fff";e.ctx.font="6pt monospace";e.ctx.fillText(n[0]+" "+n[1]+"/"+n[2],this.stats.pos[0]+5,this.stats.pos[1]+13)}},setScreen:function(t,n){var r=this;n=n||{};this.screenPrev=this.screen;this.screen=t;if(this.screenPrev){this._fade={ratio:1,type:n.type||"inout",color:n.color||"#000"};e.timer(n.time||20,function(e){r._fade.ratio=1-e},function(){r._fade.ratio=0;r.screenPref=null})}},setDialog:function(e){this.dialog=e},clearDialog:function(){this.setDialog(null)}});e.Game=t})(window.Ω);
